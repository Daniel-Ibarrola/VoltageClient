# Cognito flow

1. A new user is created and tries to authenticate. However, he will not receive a token because he must uptade
his password.
```shell
aws cognito-idp initiate-auth \
  --client-id <ClientID>  \
  --auth-flow USER_PASSWORD_AUTH  \
  --auth-parameters "USERNAME=<User>,PASSWORD=<Password>"
```

Response example (Password must be updated):

```json
{
    "ChallengeName": "NEW_PASSWORD_REQUIRED",
    "Session": "AYABeCmhlRlm1apF_LCDQfsZNJQAHQABAAdTZXJ2aWNlABBDb2duaXRvVXNlclBvb2xzAAEAB2F3cy1rbXMAS2Fybjphd3M6a21zOnVzLWVhc3QtMjo0MTc1Njc5MDM0Njk6a2V5LzVjZDI0ZDRjLWVjNWItNGU4Ny05MGI2LTVkODdkOTZmY2RkMgC4AQIBAHjif3k0w30uAyP92ifoZ0jN6g50UW_KR0w9Vv2c_wlQAgHJrU4wU_086NCX1i2iEGMbAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMqMDfrxqjsFhQn4jhAgEQgDs4XMRWguAex3x4NJJ8BDTrFbOCIwab_xj8cJADB0DGDHJ_FZ2kWJ_RC5drINdCoE91snxZrZQm7HbNyAIAAAAADAAAEAAAAAAAAAAAAAAAAAB769c939rJshbdE8_mbERJ_____wAAAAEAAAAAAAAAAAAAAAEAAADVk0cwIvKswiYf-nURDl1UAhzIuXGZ48BcB14bySyGbOPFjPW8oZxbjO7WYufSX2uovosfKmF9g_HvwnHAOQnGIO8wIDU9fJE3r4gCIzNoJf6H3_3dIuXARJ89EwvzbsV40PVF3nTHU_eSsQSgHhJ-Ini75HG-j1uo9TsW-9W-G7p9myi3VB8wjREmI4w2_ahBvE2PY-C2djVE8QjDfH19U3FcK8-dylu6RhOV5lz626n8S4dTs-1DUs9lmaqcFJuAntEOk8yYf_x8oCHE-mbCZD-5Kt3DDcaSNWsCNkZBlHI-1imR6w",
    "ChallengeParameters": {
        "USER_ID_FOR_SRP": "d5d8be32-e59a-4ee5-b4c8-479bb9653305",
        "requiredAttributes": "[]",
        "userAttributes": "{\"email\":\"dis96051@gmail.com\"}"
    }
}
```

2. Newly created user updates password by responding to auth challenge
```shell
aws cognito-idp admin-respond-to-auth-challenge \
  --user-pool-id <UserPoolId> \
  --client-id <ClientId> \
  --challenge-name NEW_PASSWORD_REQUIRED \
  --challenge-responses "USERNAME=<Username>,NEW_PASSWORD=<NewPassword>" \
  --session <SessionID>
```

Response example:

```json
{
  "ChallengeParameters": {},
  "AuthenticationResult": {
    "AccessToken": "eyJraWQiOiJGUzlTa1AwTGp0VXk4OHc4cjlCaCtDeFF4aXFhaWhCRmRCQndFN2RKR0FjPSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiJkNWQ4YmUzMi1lNTlhLTRlZTUtYjRjOC00NzliYjk2NTMzMDUiLCJpc3MiOiJodHRwczpcL1wvY29nbml0by1pZHAudXMtZWFzdC0yLmFtYXpvbmF3cy5jb21cL3VzLWVhc3QtMl9iNWJta1IyUkkiLCJjbGllbnRfaWQiOiI3cDA2NWJncWphODliM3BrcGNjbm1sM2x0NyIsIm9yaWdpbl9qdGkiOiJiZDkxMjZmOS1jNTYyLTRiOWEtYWZhMS0wODg5OGQ4MDlhMzMiLCJldmVudF9pZCI6IjZmNGYyNTE5LWRmMTQtNDYwZS1hZDc1LWQ1NjEwNjI0OTFhYyIsInRva2VuX3VzZSI6ImFjY2VzcyIsInNjb3BlIjoiYXdzLmNvZ25pdG8uc2lnbmluLnVzZXIuYWRtaW4iLCJhdXRoX3RpbWUiOjE3MDA2OTIyNzMsImV4cCI6MTcwMDY5NTg3MywiaWF0IjoxNzAwNjkyMjczLCJqdGkiOiI1ZmMxNTRkMS1iZGMzLTQ2ZTctYjY0ZC02MDRjMTJkNzEwODUiLCJ1c2VybmFtZSI6ImQ1ZDhiZTMyLWU1OWEtNGVlNS1iNGM4LTQ3OWJiOTY1MzMwNSJ9.sR8BQHJkKN4QvrcuLRivc48GR1PQGMs0JgjBKDZxAQvlUocnEUeGpevvmV8sFtGrSWIqDkPRFOXvE1a87TftEJ1AAG4pTjeOuz-yd8gBTy0DJ9YeLNEP4eQ4xppPwoahQD2qKhmaQ_1emiOmjvQDi7pZWdMco_239MtcmmGZ7nXt5dPJBy2ZCCpnSkY5cue2LY2ny3KHqU8azHd7OBhsSOiY9K_d8Qb_HtGt6QSRdbg0_fRuzWupRv1DYZ9l7vXrq2CCMeL7sdshYrV88Zxq_wOCeuAWnOa77OcyJ4fNmWZslUWXnnTyi0-V_-bKt_xp27uM27DyGvfXY4HZnivWTA",
    "ExpiresIn": 3600,
    "TokenType": "Bearer",
    "RefreshToken": "eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9BRVAifQ.1axY0OjudtUD1WWI0RvShgTe8J8sfeHF8TCW5YVax6aXjOFuUscp-5UJoUfPnn8lI30XiWDqRvCbeGBhllOE_XHh94wrPcU1UeNhCqVmw_1dWKaiO0J8Kc6Uj8EVwU2GMQNppdAD5b6pRz_ku3AO3N-d-qnGtifggbkJDoLX_uA5F9jzP-au3l2K4iAu5pckoPMlj7vy_-R6VyfpAzaSQlSq-Up5fO_UrQEW6w-SsPtvFxus0GMOtjzRz_ARqk-fBD6IFbvkWCysKki6EcnwPO-0V7R2ocBaFM1kjC73f7gF8xgj4jenCj3bZuLRJWXxCufWJ6GOgwxL6EpTLj95uQ.PNWchhRXSxC_T1m3.JLV2jzhBZbH-ZnpMZxfNnMagIaOSO_KDxEu2PKShIHVJ3iMMIzIVzVj3iY4pqr7C2w639IkvdyQWH2tl-cM7_NraNbNfo6pJ2CDlphOnLrFONFr75P5QnbRqJoju9L8lbcBL00H67YYUjJPy2K90NwDNMcqoxuvLkVKUVYc6kMZT1sjajCIDRE6_cMkD2bX1AG-6VbxYt7OmoUM82rdXPznx6dfPBP6f7duWM2sBwDy8fjhcAMYvvp6CfBfntwzy6OuirlNAPoFGEthgza3md8N7P13B4_Z2s18aHE1R-pnRcXCSeq-VOrE7DvLNQncndmu8m528bfs5HMvw6GDC5Mpmr_J3WDuCDKE119r8ICwMnHjQ8ihh1Ov2su_hqB1iuC-UOoNsmJUVOHCV1pffkEc3Wr0I8Zua1L8Z37M1iUh5ls0hX8Q8NLMF0iBTrBTscXa54JLg3JDdSdmxJtG6Kgu7D0LHRZINc8q4srgHlVe_VCfTxy48f7mHNVpPXmn4H39yGW_G40mdOLgIdL-WjU_BHAGWsZ3Tmt-Sypc1_I2yNSSrjyvTbYDzsCJiWXLHwkqIlFa4Jh5PAK-O_RS_orQ8ADDPRCUtByOadTC0iLSWw7B7Ng-_1ty2nUzLDmeduCeO4B3qfMV-ya2dHzk5oFa9C5sNcY-F_MyPVlvu3J1YssZ4D4sQL1epupsYMyjkCqMqjuN4qigzOnxDsT_naVVpsOm7BW2OevuqYVfre_DyM-h31Po6yp53uMRELLPrqxEfJn2BRewsz92tttSINts-wWpQWNjEIXt7yvDpn97lJ5HmST9ppyrxVy_9F7YwTXLXcAcbeXARx-dsmzb7a9FU2NzIWjKdZds5uUjpDao19lMd8Masgcrz2IRtuD1g1VS_PdyJ92aBuvbCVZsTpNOIG0sJcq1hD_2zCw1YMY5hnKx1cn8qIMUgQaaVpu0QXdXfpHR_bAuTibvw1bIdablvyook9fS1sqnxJPHyl8pRfvFf5kOOvphCxpneRC4M-5kxB4llHjrOl_CQ6lPVUBf-qqbyTSFrq9R2VJK0SeM9AlmvmTwofyh8luK2i3kSnWDk3rro-9XvIDZFnUcagAjGL191BUMcgRMhUeelB-3H6q4JmzKZdUJwbBrLnJvIsVgMZ8E3AaithpdBMzx23CpQRYcY2iOXZcuFZluigezMCb5Aq_yTnlE02Et0MNDG17Zmm055MgVdu4wk6dAwWIa_v2wmDCV2dvmSzAEwbygZS-J5WW5VtMvr9Xq_7Hgq3dO078NthxPJUTb8sJuqy81rtMKGQZ4w9LWlaSDnOSkr9l12Ulczc1oZCQ.tcbpX13LhGWl4qGL4NqEtQ",
    "IdToken": "eyJraWQiOiJQM3NrZXhWNFwvQjluMUxsWlRiTUlkUFNuUWFhTXRPbWFxNGxkOWVNb0lGQT0iLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJkNWQ4YmUzMi1lNTlhLTRlZTUtYjRjOC00NzliYjk2NTMzMDUiLCJpc3MiOiJodHRwczpcL1wvY29nbml0by1pZHAudXMtZWFzdC0yLmFtYXpvbmF3cy5jb21cL3VzLWVhc3QtMl9iNWJta1IyUkkiLCJjb2duaXRvOnVzZXJuYW1lIjoiZDVkOGJlMzItZTU5YS00ZWU1LWI0YzgtNDc5YmI5NjUzMzA1Iiwib3JpZ2luX2p0aSI6ImJkOTEyNmY5LWM1NjItNGI5YS1hZmExLTA4ODk4ZDgwOWEzMyIsImF1ZCI6IjdwMDY1YmdxamE4OWIzcGtwY2NubWwzbHQ3IiwiZXZlbnRfaWQiOiI2ZjRmMjUxOS1kZjE0LTQ2MGUtYWQ3NS1kNTYxMDYyNDkxYWMiLCJ0b2tlbl91c2UiOiJpZCIsImF1dGhfdGltZSI6MTcwMDY5MjI3MywiZXhwIjoxNzAwNjk1ODczLCJpYXQiOjE3MDA2OTIyNzMsImp0aSI6ImRjOGQ5YzE3LWViYjctNDljNi1hZTM3LWMzYWEzZmNkMzUxNyIsImVtYWlsIjoiZGlzOTYwNTFAZ21haWwuY29tIn0.d5gO92WfXkeQbhrMhiUFkCJpvK3Xn5AkHom0yZpYd6S-QWvVcwOYQE94C27CTU1KVkT5UBwdni2_Y-z80GBuPuhKSgQlrqIHwSmf9OJNZD0ja7x1lnuTeB-N8UZTMEXgCXGfcCrEm6e0Esuj7QRG963kv_sWeR2pPLto3lVhvZzQ19EFP_5GsgWZI6l_1NJPcqvjqibJ2pTVmdqAe7XQcRpcXWj8TRlD_44LgrANxUGH9O8qpKucuJOMZTh_m_NdbDcl-qS4O5iVh9gZrIxAmxO3HYclmAzlzcQmcOdjDsMEZLKqaOXJ8S262YZXEsfAQbtczTEG6E3sxQLR6ppHuw"
  }
}
```
3. The user can now happily get token via normal authentication:

```shell
aws cognito-idp initiate-auth --client-id <ClientID>  \
  --auth-flow USER_PASSWORD_AUTH  \
  --auth-parameters "USERNAME=<User>,PASSWORD=<Password>"
```

Response example:
```json
{
    "ChallengeParameters": {},
    "AuthenticationResult": {
        "AccessToken": "eyJraWQiOiJGUzlTa1AwTGp0VXk4OHc4cjlCaCtDeFF4aXFhaWhCRmRCQndFN2RKR0FjPSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiJkNWQ4YmUzMi1lNTlhLTRlZTUtYjRjOC00NzliYjk2NTMzMDUiLCJpc3MiOiJodHRwczpcL1wvY29nbml0by1pZHAudXMtZWFzdC0yLmFtYXpvbmF3cy5jb21cL3VzLWVhc3QtMl9iNWJta1IyUkkiLCJjbGllbnRfaWQiOiI3cDA2NWJncWphODliM3BrcGNjbm1sM2x0NyIsIm9yaWdpbl9qdGkiOiI5ZmUwZWRjNy1hZTEyLTQzZGYtYTMxYi1kMzM0Nzg4NjRjNzIiLCJldmVudF9pZCI6ImZjNTc5OGEwLWNmYzgtNDFjZC05MzE2LTVhYzIwMjI5MjgyOSIsInRva2VuX3VzZSI6ImFjY2VzcyIsInNjb3BlIjoiYXdzLmNvZ25pdG8uc2lnbmluLnVzZXIuYWRtaW4iLCJhdXRoX3RpbWUiOjE3MDA2OTIzOTAsImV4cCI6MTcwMDY5NTk5MCwiaWF0IjoxNzAwNjkyMzkwLCJqdGkiOiI1MDY3NzU2MS04ZGQ3LTQyZDEtYmQzNy1iMTEzNDk1YzJmNGYiLCJ1c2VybmFtZSI6ImQ1ZDhiZTMyLWU1OWEtNGVlNS1iNGM4LTQ3OWJiOTY1MzMwNSJ9.Lvk6DEFysm8iLMaktefviL9G8juaTshjlnac-kT0H34t0DtJfxph3hbKvmW-PL6LaqeFtyfWZNAq-YGBw8srK1xHClZTIEQBH4BW5PH_YWZ-SU5zKCSLaHHnoQKXC4X5Wk73Nub5EHHrm1nwnoCgPCXQYl_seroc6xhOdf1GpQaVeal1gF6SnoX3HEXVLAzX1N81i4LcMdjRzSZlPEcGqNNAvFUPTpv3Jtmd4E4HsZXTaoF1H6pxXit92Ya7SARZUBAebaJy-UWJY3WM63Y5vXmM1bgMstxbGYEVbymdRgrHhNjIdCzePANpgvGgZglR6yEEdRZzakqcNnpwVynLMA",
        "ExpiresIn": 3600,
        "TokenType": "Bearer",
        "RefreshToken": "eyJjdHkiOiJKV1QiLCJlbmMiOiJBMjU2R0NNIiwiYWxnIjoiUlNBLU9BRVAifQ.KyNBRsp-UPE3J-bZn5sT8j_HgqgGuGrzOA7VbSYMw6AdBTnE7gfWhPjQcoo220TrH7WR_pbxBSKHEI15aPhpo5NdFUqtm0cfcw9YzXfn4EZvEEI-PhoosHgEf-XDqvyQZ0n388_xh6hBmRiog3VK_fSL2MvN02Kv0qfjylGKmYbxdlFFtYUEwI2W2RLencsdC73zlcyBQyiae2enfn_sz7jZtuqxnLg2oygmYAMtRURqgMHqFrSgJFYt0aKxg046WtJb4TKWhv3e7Rp3wODqz_aNRxItDdJxhU0qXjwho_segbf_-dYNI8K3heD2WwBseXSDr91WmYE7VYGdnfiChw.x87-zFwF5fzuFIEm.yHf9iIkEYBpJ50T7NoZA01uoZmKLiQhlThJgDEr40t1UVt2Y4jHz0VhiYZbYEW0-aT_AeeX13TrxA3l9LWmN-Yf2dpnSXKTCyLlu6-LNqzTtK3G5wZ4fqY8_5pU91_hVF7lyXhE4vHUactI3q7wBd-jKas4XEaA3H0wHAy7G9wW6gYFFIUDWS11t0Mcswt7PZLasu9QExDUbu7-h1jXH-DT7PvKEKRiGKtSH9D7hODjRBpDiVdhbqAtE0O5wApzHRLzJ4PXWewdwnAD9SE3QEKts6L-q4ZHSYDtloYZOU0-rDH-l3IafD5gzOkwv0JisDPXFzixxprjCJy2_sodQZwxxvdA5KqyhDEqilEW76jWE8oRZcQ4rwzgBiSlFjYnobHA-jNKU6QRpA4DfxFvLEBLNSXUPwJ9mn4JDov2oJ2nAknCW4IowVIsqAzvVP9VkZRfcwmK0jz1orTO96jm_VGOMYGaPWlMbHT80BFafXlqMGAvvr565wUxhb6leCiTxW38HlaiSdgmemNZPsmM3y8qNwDt78jVu-qTEglkJ3bLOicR7PqFx57SWd0QkalfmSFe34z6WOlp0KVQKUVk0MMfuxQKgboOXKyySTyu0rBx_B-Mjsh17iKlVH5AIcXPJdAym6bIesPGjqp119BMUSKOXcmL2k6t0-b4DHsxD_h82cGB-G0sRra1kTe36wPnJpTVR8wbZGB3_dxOja5vQYq7YPDhz4VEmT4Flt9sqVcREWT448C6V9J9KlQBziyqvuQxhqYpqTbg1U4rZuIdaeYK-D6vEXjsiGZhNK5-MRsYT333zwP-SqA32hMa9y21poUwtbVSLGCSR8dDUAzmkszInm92wI5VXXtcvDdM6Z9kSCzgOngHORqxCprwG4mI556S5xSCsMDhEDxPsNJBGMkMTeGu4G0TCo4FExd3oDXDKIipdffo6lB0FBrsxTPaZdwsXUeUn26ORVib6nIO_rW-AEf83sm-4ZuJFseZioqC4YLKqGAIKWgowIy3sktuKyKNFcaMHgcwhLd5YlV1zz2ymm8TEVRwJWYHfIFx85ZbSIyHKp9L9O5Bz2gPbJ143pOyujiOm7b7cZaBrjuI-rXYOp1hroXuCP9S14n_WDWMM2OfssJXxhf1L84aRv3hgXE4RI-Ois1teavQKhRvv_k1KKgXLYqW_OrLGdXkN7E8dAoTxJt2EzqvdXAiRxFpkwBqre7F5NDdpnKkiyj6sfnzl4Z-v0q4Yt1eBheWsMvJ8oEZypfRJarHRp5AIjPRt-Gn9X9lGqpF1fMoxbx48VdzPP__g9HCcPLZG22IHwWonfwVWYKUxhm1ivw.WGYn9LcqLXitMePTkejztQ",
        "IdToken": "eyJraWQiOiJQM3NrZXhWNFwvQjluMUxsWlRiTUlkUFNuUWFhTXRPbWFxNGxkOWVNb0lGQT0iLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJkNWQ4YmUzMi1lNTlhLTRlZTUtYjRjOC00NzliYjk2NTMzMDUiLCJpc3MiOiJodHRwczpcL1wvY29nbml0by1pZHAudXMtZWFzdC0yLmFtYXpvbmF3cy5jb21cL3VzLWVhc3QtMl9iNWJta1IyUkkiLCJjb2duaXRvOnVzZXJuYW1lIjoiZDVkOGJlMzItZTU5YS00ZWU1LWI0YzgtNDc5YmI5NjUzMzA1Iiwib3JpZ2luX2p0aSI6IjlmZTBlZGM3LWFlMTItNDNkZi1hMzFiLWQzMzQ3ODg2NGM3MiIsImF1ZCI6IjdwMDY1YmdxamE4OWIzcGtwY2NubWwzbHQ3IiwiZXZlbnRfaWQiOiJmYzU3OThhMC1jZmM4LTQxY2QtOTMxNi01YWMyMDIyOTI4MjkiLCJ0b2tlbl91c2UiOiJpZCIsImF1dGhfdGltZSI6MTcwMDY5MjM5MCwiZXhwIjoxNzAwNjk1OTkwLCJpYXQiOjE3MDA2OTIzOTAsImp0aSI6IjA4N2EwYWRlLTc4ODctNGI4My1iZGIzLTIxZjA5ZTM2NDRjNiIsImVtYWlsIjoiZGlzOTYwNTFAZ21haWwuY29tIn0.F13wxG38sIh5rK6d_txaoJDZzbBTAoAi1jjEpfUoh7FwnOtiPXYrkmR_3kniTWsHYp7UjHekSczxvJUTcn9aIuKsttMUbb_GFzKdBFFxadwaotEgxKXn3JXbVcqd5eRMScLWyin3oreMbiJD5Ai0bGOG9WtgVWl6Zbz_3iC80GUMJWMRsNacF4Fb4qbYa6DbCRT2V_o7tWtC081Qx19bjFkTZXDcAzA8ryxn0-fuYeE_IyTNbmLB-RzIoCf5n7MKlWXhO7X8MsGZZWht7ruBNJD3ToOiUEIYJAQNBoXi2Y5GT8AW5wFmuO30CSCVVEUH8PvVut5MO4rDpMT1cA-7vg"
    }
}
```

4. The user forgot its password, so he requests a password reset.

```shell
aws cognito-idp forgot-password --client-id <ClientId> --username <UserName>
```

Response example:
```json
{
    "CodeDeliveryDetails": {
        "Destination": "t***@e***",
        "DeliveryMedium": "EMAIL",
        "AttributeName": "email"
    }
}
```

The user is emailed a confirmation code that he needs to reset his password.

**Note**: This will raise an error if the user has not verified its email.

5. The user resets its password

````shell
aws cognito-idp confirm-forgot-password \
  --client-id <ClientId> \
  --username <Username> \
  --password <NewPassword> \
  --confirmation-code <ConfirmationCode>
````

Response example: The response is empty.

The user can authenticate again.

## Notes

When creating new users we can mark their email addresses as verified. This way we don't need to confirm the account.

